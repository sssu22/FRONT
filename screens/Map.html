<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=34bb066fa35861f283d741758f61344f&libraries=clusterer"></script>
    <style>
      html, body { 
        margin: 0; 
        padding: 0; 
        width: 100%; 
        height: 100%; 
      }
      #map { 
        width: 100%; 
        height: 100%; 
        background-color: #f0f0f0;
      }
      #debug {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        max-width: 200px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="debug">ë¡œë”© ì¤‘...</div>
    <div id="map"></div>
    <script>
      const debugDiv = document.getElementById('debug');
      
      function log(message) {
        console.log(message);
        debugDiv.innerHTML += '<br>' + message;
      }
      
      log('ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
      
      // Kakao ê°ì²´ í™•ì¸
      if (typeof kakao === 'undefined') {
        log('âŒ Kakao ê°ì²´ ì—†ìŒ');
        debugDiv.innerHTML = 'âŒ ì¹´ì¹´ì˜¤ API ë¡œë“œ ì‹¤íŒ¨<br>ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”';
        // ì¹´ì¹´ì˜¤ API ì—†ì´ ê¸°ë³¸ ì§€ë„ í‘œì‹œ
        document.getElementById('map').innerHTML = `
          <div style="
            width: 100%; 
            height: 100%; 
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-family: Arial, sans-serif;
          ">
            <h3>ğŸ—ºï¸ ì§€ë„ ì˜ì—­</h3>
            <p>ì¹´ì¹´ì˜¤ API ë¡œë“œ ì‹¤íŒ¨</p>
            <p style="font-size: 12px;">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”</p>
          </div>
        `;
      } else {
        log('âœ… Kakao ê°ì²´ ì¡´ì¬');
        
        try {
          const mapContainer = document.getElementById('map');
          log('âœ… ì§€ë„ ì»¨í…Œì´ë„ˆ ì°¾ìŒ');
          
          const mapOptions = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 7,
          };
          log('âœ… ì§€ë„ ì˜µì…˜ ì„¤ì •');
          
          const map = new kakao.maps.Map(mapContainer, mapOptions);
          log('âœ… ì§€ë„ ìƒì„± ì™„ë£Œ');
          
          // 3ì´ˆ í›„ ë””ë²„ê·¸ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
          setTimeout(() => {
            debugDiv.style.display = 'none';
          }, 3000);
          
          let clusterer = null;

          // React Native WebViewì—ì„œ ë©”ì‹œì§€ ë°›ê¸°
          window.addEventListener("message", function (event) {
            try {
              log('ğŸ“¨ ë©”ì‹œì§€ ë°›ìŒ: ' + event.data);
              const data = JSON.parse(event.data);
              const positions = data.positions;
              
              if (!positions || !Array.isArray(positions)) {
                log('âŒ ìœ„ì¹˜ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹˜');
                return;
              }

              // ê¸°ì¡´ í´ëŸ¬ìŠ¤í„°ëŸ¬ê°€ ìˆë‹¤ë©´ ì œê±°
              if (clusterer) {
                clusterer.clear();
                log('ğŸ—‘ï¸ ê¸°ì¡´ í´ëŸ¬ìŠ¤í„°ëŸ¬ ì œê±°');
              }

              // ìƒˆ í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
              clusterer = new kakao.maps.MarkerClusterer({
                map: map,
                averageCenter: true,
                minLevel: 6,
              });
              log('ğŸ”— ìƒˆ í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±');

              // ìœ íš¨í•œ ìœ„ì¹˜ ë°ì´í„°ë§Œ í•„í„°ë§
              const validPositions = positions.filter(pos => 
                pos.lat && pos.lng && pos.lat !== 0 && pos.lng !== 0
              );
              
              log('ğŸ“ ìœ íš¨í•œ ìœ„ì¹˜: ' + validPositions.length + 'ê°œ');

              if (validPositions.length === 0) {
                log('âš ï¸ í‘œì‹œí•  ìœ„ì¹˜ ë°ì´í„° ì—†ìŒ');
                return;
              }

              const markers = validPositions.map(pos => {
                const marker = new kakao.maps.Marker({
                  position: new kakao.maps.LatLng(pos.lat, pos.lng)
                });

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(marker, 'click', function () {
                  log('ğŸ–±ï¸ ë§ˆì»¤ í´ë¦­: ' + pos.district);
                  if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(
                      JSON.stringify({ district: pos.district })
                    );
                  }
                });

                return marker;
              });

              // ë§ˆì»¤ë“¤ì„ í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ì¶”ê°€
              clusterer.addMarkers(markers);
              log('âœ… ë§ˆì»¤ ' + markers.length + 'ê°œ ì¶”ê°€');

              // ì§€ë„ ì¤‘ì‹¬ì„ ì²« ë²ˆì§¸ ë§ˆì»¤ë¡œ ì´ë™
              if (validPositions.length > 0) {
                const firstPos = validPositions[0];
                map.setCenter(new kakao.maps.LatLng(firstPos.lat, firstPos.lng));
                log('ğŸ¯ ì§€ë„ ì¤‘ì‹¬ ì´ë™');
              }

            } catch (error) {
              log('âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì—ëŸ¬: ' + error.message);
              console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            }
          });
          
        } catch (error) {
          log('âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
          console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          
          // ì—ëŸ¬ ì‹œ ê¸°ë³¸ ì§€ë„ í‘œì‹œ
          document.getElementById('map').innerHTML = `
            <div style="
              width: 100%; 
              height: 100%; 
              background: #ffcdd2;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-direction: column;
              font-family: Arial, sans-serif;
            ">
              <h3>âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨</h3>
              <p>${error.message}</p>
            </div>
          `;
        }
      }
    </script>
  </body>
</html>